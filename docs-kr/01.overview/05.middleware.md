# **ë¯¸ë“¤ì›¨ì–´ (Middleware)**

ë¯¸ë“¤ì›¨ì–´ëŠ” **ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ê°€ ì‹¤í–‰ë˜ê¸° ì „ì— í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜**ì…ë‹ˆë‹¤.  
ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ëŠ” **ìš”ì²­ ê°ì²´(request), ì‘ë‹µ ê°ì²´(response), ê·¸ë¦¬ê³  `next()` ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜**ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ìš”ì²­-ì‘ë‹µ ì‚¬ì´í´ì—ì„œ **ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜**ëŠ” ì¼ë°˜ì ìœ¼ë¡œ `next` ë³€ìˆ˜ë¡œ í‘œí˜„ë©ë‹ˆë‹¤.

![ë¯¸ë“¤ì›¨ì–´ ì´ë¯¸ì§€](https://docs.nestjs.com/assets/Middlewares_1.png)

---

## **Nestì˜ ë¯¸ë“¤ì›¨ì–´**

Nestì˜ ë¯¸ë“¤ì›¨ì–´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ **Expressì˜ ë¯¸ë“¤ì›¨ì–´ì™€ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ë™ì‘**í•©ë‹ˆë‹¤.  
ì•„ë˜ëŠ” Express ê³µì‹ ë¬¸ì„œì—ì„œ ì„¤ëª…í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ì˜ ê¸°ëŠ¥ì…ë‹ˆë‹¤.

**ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ëŠ” ë‹¤ìŒ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

- **ì„ì˜ì˜ ì½”ë“œ ì‹¤í–‰**
- **ìš”ì²­ ë° ì‘ë‹µ ê°ì²´ ìˆ˜ì •**
- **ìš”ì²­-ì‘ë‹µ ì‚¬ì´í´ ì¢…ë£Œ**
- **ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ í˜¸ì¶œ**

ë§Œì•½ í˜„ì¬ ë¯¸ë“¤ì›¨ì–´ê°€ ìš”ì²­-ì‘ë‹µ ì‚¬ì´í´ì„ ì¢…ë£Œí•˜ì§€ ì•ŠëŠ”ë‹¤ë©´,  
**`next()`ë¥¼ ë°˜ë“œì‹œ í˜¸ì¶œí•˜ì—¬ ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ë¡œ ì œì–´ë¥¼ ë„˜ê²¨ì•¼ í•©ë‹ˆë‹¤.**  
ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ **ìš”ì²­ì´ ëŒ€ê¸° ìƒíƒœë¡œ ë‚¨ì•„ìˆê²Œ ë©ë‹ˆë‹¤.**

---

## **Nestì—ì„œ ë¯¸ë“¤ì›¨ì–´ êµ¬í˜„í•˜ê¸°**

ë¯¸ë“¤ì›¨ì–´ëŠ” **í´ë˜ìŠ¤ ê¸°ë°˜** ë˜ëŠ” **í•¨ìˆ˜ ê¸°ë°˜**ìœ¼ë¡œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•  ê²½ìš°, `@Injectable()` ë°ì½”ë ˆì´í„°ë¥¼ ì ìš©í•˜ê³  `NestMiddleware` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.  
ë°˜ë©´, í•¨ìˆ˜ ê¸°ë°˜ ë¯¸ë“¤ì›¨ì–´ëŠ” íŠ¹ë³„í•œ ì¸í„°í˜ì´ìŠ¤ ìš”êµ¬ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.

### **í´ë˜ìŠ¤ ê¸°ë°˜ ë¯¸ë“¤ì›¨ì–´ ì˜ˆì œ**

```typescript
import { Injectable, NestMiddleware } from "@nestjs/common";
import { Request, Response, NextFunction } from "express";

@Injectable()
export class LoggerMiddleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    console.log("Request...");
    next();
  }
}
```

---

## **ì˜ì¡´ì„± ì£¼ì… (Dependency Injection) ì§€ì›**

Nestì˜ ë¯¸ë“¤ì›¨ì–´ëŠ” **ì˜ì¡´ì„± ì£¼ì…(DI)ì„ ì™„ë²½íˆ ì§€ì›í•©ë‹ˆë‹¤.**  
ì„œë¹„ìŠ¤ ë˜ëŠ” ë‹¤ë¥¸ ì˜ì¡´ì„±ì„ ì£¼ì…ë°›ì„ ìˆ˜ ìˆìœ¼ë©°,  
ì´ëŠ” **ì»¨íŠ¸ë¡¤ëŸ¬ ë° í”„ë¡œë°”ì´ë”ì™€ ë™ì¼í•œ ë°©ì‹**ìœ¼ë¡œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.

---

## **ë¯¸ë“¤ì›¨ì–´ ì ìš©í•˜ê¸°**

ë¯¸ë“¤ì›¨ì–´ëŠ” `@Module()` ë°ì½”ë ˆì´í„° ì•ˆì—ì„œ ì§ì ‘ ì •ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.  
ëŒ€ì‹ , **ëª¨ë“ˆ í´ë˜ìŠ¤ì—ì„œ `configure()` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¤ì •í•©ë‹ˆë‹¤.**

ë¯¸ë“¤ì›¨ì–´ê°€ í¬í•¨ëœ ëª¨ë“ˆì€ **ë°˜ë“œì‹œ `NestModule` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.**

---

### **ë¯¸ë“¤ì›¨ì–´ë¥¼ `AppModule` ì—ì„œ ì„¤ì •í•˜ê¸°**

```typescript
import { Module, NestModule, MiddlewareConsumer } from "@nestjs/common";
import { LoggerMiddleware } from "./common/middleware/logger.middleware";
import { CatsModule } from "./cats/cats.module";

@Module({
  imports: [CatsModule],
})
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer.apply(LoggerMiddleware).forRoutes("cats");
  }
}
```

ìœ„ ì½”ë“œì—ì„œ:

- `LoggerMiddleware` ëŠ” `/cats` ë¼ìš°íŠ¸ì— ì ìš©ë©ë‹ˆë‹¤.
- ì¦‰, `CatsController`ì˜ **ëª¨ë“  ìš”ì²­ì— ëŒ€í•´ `LoggerMiddleware`ê°€ ì‹¤í–‰**ë©ë‹ˆë‹¤.

---

### **íŠ¹ì • HTTP ë©”ì„œë“œì—ë§Œ ë¯¸ë“¤ì›¨ì–´ ì ìš©í•˜ê¸°**

íŠ¹ì • HTTP ë©”ì„œë“œ(ì˜ˆ: `GET`)ì—ë§Œ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì ìš©í•˜ë ¤ë©´  
`forRoutes()` ë©”ì„œë“œì— ê°ì²´ë¥¼ ì „ë‹¬í•˜ë©´ ë©ë‹ˆë‹¤.

```typescript
import {
  Module,
  NestModule,
  RequestMethod,
  MiddlewareConsumer,
} from "@nestjs/common";
import { LoggerMiddleware } from "./common/middleware/logger.middleware";
import { CatsModule } from "./cats/cats.module";

@Module({
  imports: [CatsModule],
})
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer
      .apply(LoggerMiddleware)
      .forRoutes({ path: "cats", method: RequestMethod.GET });
  }
}
```

### **ğŸ’¡ íŒíŠ¸**

- `configure()` ë©”ì„œë“œëŠ” **ë¹„ë™ê¸°(async/await) ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.**
- ì˜ˆë¥¼ ë“¤ì–´, **ë¹„ë™ê¸° ì‘ì—…ì„ ê¸°ë‹¤ë¦° í›„ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì„¤ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.**

---

### **âš ï¸ ì£¼ì˜ ì‚¬í•­**

- Express ì–´ëŒ‘í„°ë¥¼ ì‚¬ìš©í•  ê²½ìš°, **NestJSëŠ” `body-parser` íŒ¨í‚¤ì§€ì˜ `json()` ë° `urlencoded()`ë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ ë“±ë¡í•©ë‹ˆë‹¤.**
- ë§Œì•½ `MiddlewareConsumer`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¥¼ ì»¤ìŠ¤í…€í•˜ë ¤ë©´,  
  **`NestFactory.create()`ì—ì„œ `bodyParser: false` ì˜µì…˜ì„ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.**

---

## **ë¼ìš°íŠ¸ ì™€ì¼ë“œì¹´ë“œ(Route Wildcards) ì§€ì›**

NestJSì˜ ë¯¸ë“¤ì›¨ì–´ëŠ” **íŒ¨í„´ ê¸°ë°˜ ë¼ìš°íŠ¸**ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, `"abcd/*"` ì™€ì¼ë“œì¹´ë“œë¥¼ ì‚¬ìš©í•˜ë©´  
**"abcd/"ë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  ê²½ë¡œì— ëŒ€í•´ ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.**

```typescript
forRoutes({
  path: "abcd/*splat",
  method: RequestMethod.ALL,
});
```

---

### **ğŸ’¡ íŒíŠ¸**

- `*splat` ì€ ë‹¨ìˆœíˆ ì™€ì¼ë“œì¹´ë“œ ì´ë¦„ì´ë©°, **ì–´ë–¤ ì´ë¦„ìœ¼ë¡œë“  ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**
- `abcd/*` ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê²½ë¡œì™€ ì¼ì¹˜í•©ë‹ˆë‹¤.
  - `/abcd/1`
  - `/abcd/123`
  - `/abcd/abc`
- ê·¸ëŸ¬ë‚˜ `/abcd/` ìì²´ëŠ” í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ë§Œì•½ `/abcd/` ë„ í¬í•¨í•˜ë ¤ë©´,  
ì™€ì¼ë“œì¹´ë“œë¥¼ `{}` ë¡œ ê°ì‹¸ **ì„ íƒì (optional) ë§¤ì¹­**ìœ¼ë¡œ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.

```typescript
forRoutes({
  path: "abcd/{*splat}",
  method: RequestMethod.ALL,
});
```

---

## **ë¯¸ë“¤ì›¨ì–´ ì†Œë¹„ì (Middleware Consumer)**

`MiddlewareConsumer`ëŠ” **ë¯¸ë“¤ì›¨ì–´ë¥¼ ê´€ë¦¬í•˜ëŠ” í—¬í¼ í´ë˜ìŠ¤**ì…ë‹ˆë‹¤.  
ë‹¤ì–‘í•œ ë‚´ì¥ ë©”ì„œë“œë¥¼ ì œê³µí•˜ë©°, **ë©”ì„œë“œ ì²´ì´ë‹(fluent style) ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

---

### **íŠ¹ì • ì»¨íŠ¸ë¡¤ëŸ¬ì— ë¯¸ë“¤ì›¨ì–´ ì ìš©í•˜ê¸°**

```typescript
import { Module, NestModule, MiddlewareConsumer } from "@nestjs/common";
import { LoggerMiddleware } from "./common/middleware/logger.middleware";
import { CatsModule } from "./cats/cats.module";
import { CatsController } from "./cats/cats.controller";

@Module({
  imports: [CatsModule],
})
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer.apply(LoggerMiddleware).forRoutes(CatsController);
  }
}
```

---

### **íŠ¹ì • ë¼ìš°íŠ¸ì—ì„œ ë¯¸ë“¤ì›¨ì–´ ì œì™¸í•˜ê¸°**

ë¯¸ë“¤ì›¨ì–´ë¥¼ íŠ¹ì • ë¼ìš°íŠ¸ì—ì„œ **ì œì™¸(exclude)** í•˜ë ¤ë©´ `exclude()` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.

```typescript
consumer
  .apply(LoggerMiddleware)
  .exclude(
    { path: "cats", method: RequestMethod.GET },
    { path: "cats", method: RequestMethod.POST },
    "cats/{*splat}"
  )
  .forRoutes(CatsController);
```

---

## **í•¨ìˆ˜ ê¸°ë°˜ ë¯¸ë“¤ì›¨ì–´ (Functional Middleware)**

ë‹¨ìˆœí•œ ë¯¸ë“¤ì›¨ì–´ì˜ ê²½ìš°, **í´ë˜ìŠ¤ ëŒ€ì‹  í•¨ìˆ˜ë¡œ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

### **í•¨ìˆ˜ ê¸°ë°˜ ë¯¸ë“¤ì›¨ì–´ ì˜ˆì œ**

```typescript
import { Request, Response, NextFunction } from "express";

export function logger(req: Request, res: Response, next: NextFunction) {
  console.log(`Request...`);
  next();
}
```

### **ì‚¬ìš© ì˜ˆì‹œ**

```typescript
consumer.apply(logger).forRoutes(CatsController);
```

### **ğŸ’¡ íŒíŠ¸**

- ë¯¸ë“¤ì›¨ì–´ê°€ **ì˜ì¡´ì„±ì„ í•„ìš”ë¡œ í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´, í•¨ìˆ˜ ê¸°ë°˜ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” ê°„ë‹¨í•©ë‹ˆë‹¤.**

---

## **ì—¬ëŸ¬ ê°œì˜ ë¯¸ë“¤ì›¨ì–´ ì ìš©í•˜ê¸°**

ì—¬ëŸ¬ ê°œì˜ ë¯¸ë“¤ì›¨ì–´ë¥¼ **ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰í•˜ë ¤ë©´**  
`apply()` ë©”ì„œë“œì— **ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì „ë‹¬**í•˜ë©´ ë©ë‹ˆë‹¤.

```typescript
consumer.apply(cors(), helmet(), logger).forRoutes(CatsController);
```

---

## **ê¸€ë¡œë²Œ ë¯¸ë“¤ì›¨ì–´ (Global Middleware)**

**ëª¨ë“  ë¼ìš°íŠ¸ì— ë¯¸ë“¤ì›¨ì–´ë¥¼ í•œ ë²ˆì— ì ìš©**í•˜ë ¤ë©´  
`INestApplication`ì˜ `use()` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.

### **`main.ts` ì˜ˆì œ**

```typescript
const app = await NestFactory.create(AppModule);
app.use(logger);
await app.listen(process.env.PORT ?? 3000);
```

---

### **ğŸ’¡ íŒíŠ¸**

- **ê¸€ë¡œë²Œ ë¯¸ë“¤ì›¨ì–´ì—ì„œëŠ” DI ì»¨í…Œì´ë„ˆë¥¼ ì§ì ‘ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.**
- ë”°ë¼ì„œ **í•¨ìˆ˜ ê¸°ë°˜ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.**
- ë˜ëŠ”, `forRoutes('*')` ë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¹ì • ëª¨ë“ˆì—ì„œ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì„¤ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
